<!DOCTYPE html>
<html>
<head>
  <title>Reset Password</title>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabaseUrl = "https://jwljahlhbyfdrtsxseeg.supabase.co";
    const supabaseKey =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3bGphaGxoYnlmZHJ0c3hzZWVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA4OTE2MTcsImV4cCI6MjA1NjQ2NzYxN30.FrT1skDMwh8dCves5ST-4wV6be3ul428GOvFFuRXkGU";
    const supabase = createClient(supabaseUrl, supabaseKey);

    async function resetPassword() {
      const status = document.getElementById("status");
      const newPassword = document.getElementById("newPassword").value;
      if (!newPassword) {
        status.textContent = "Please enter a new password.";
        return;
      }

      // Get parameters
      const params = new URLSearchParams(window.location.hash.substring(1));
      const accessToken = params.get("access_token");
      const type = params.get("type");

      // Check if link is invalid
      if (!accessToken || type !== "recovery") {
        status.textContent = "Invalid or expired recovery link.";
        return;
      }

      // Attempt to log user in with one-time-password
      const { data: verified, error: verifyError } = await supabase.auth.verifyOtp({
        type: "recovery",
        token_hash: accessToken,
      });

      // Check for verification error
      if (verifyError) {
        console.error("verifyOtp error:", verifyError);
        status.textContent = "Error verifying recovery link: " + verifyError.message;
        return;
      }

      console.log("verifyOtp success:", verified);
	
      // Attempt to update password
      const { error: updateError } = await supabase.auth.updateUser({
        password: newPassword,
      });

      // Check for update error
      if (updateError) {
        console.error("updateUser error:", updateError);
        status.textContent = "Error updating password: " + updateError.message;
      } else {
        status.textContent = "Password updated successfully!";
      }
    }

    // Add event listener for submit button
    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("submitBtn").addEventListener("click", resetPassword);
    });
    
  </script>
</head>
<body>
  <h1>Reset Password</h1>
  <input id="newPassword" type="password" placeholder="Enter new password" />
  <button id="submitBtn">Submit</button>
  <p id="status"></p>
</body>
</html>
